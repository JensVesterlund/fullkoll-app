name: iOS Release

on:
  workflow_dispatch:
    inputs:
      regen_ios:
        description: "Run one-time iOS regen (tool/ios_regen.sh) on the runner"
        required: false
        default: false
        type: boolean
      pbxproj_diag:
        description: "Enable pbxproj diagnostics (DF_ENABLE_PBXPROJ_DIAG=1)"
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: macos-latest

    env:
      DF_REGEN_IOS_IN_CI: ${{ inputs.regen_ios && '1' || '' }}
      DF_ENABLE_PBXPROJ_DIAG: ${{ inputs.pbxproj_diag && '1' || '' }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter version
        run: flutter --version

      - name: Install Dart deps
        run: flutter pub get

      # Optional: regenerate ios/ on the runner (requires the script exists in your repo)
      - name: Regenerate iOS project (optional)
        if: ${{ inputs.regen_ios }}
        run: |
          ls -la tool || true
          ls -la tool/ios_regen.sh || true
          bash tool/ios_regen.sh

      # Optional sanity check: can Ruby/xcodeproj parse Runner.xcodeproj?
      - name: Strict parse check (Runner.xcodeproj)
        run: |
          if [ -f tool/ci/xcodeproj_strict_parse_check.sh ]; then
            bash tool/ci/xcodeproj_strict_parse_check.sh
          else
            echo "WARN: tool/ci/xcodeproj_strict_parse_check.sh not found; skipping"
          fi

      # --- Signing setup must happen BEFORE build ---
      - name: Import Certificates (P12 -> keychain)
        env:
          P12_PASSWORD: ${{ secrets.IOS_CERT_P12_PASSWORD }}
          IOS_CERT_P12_BASE64: ${{ secrets.IOS_CERT_P12_BASE64 }}
        run: |
          set -euxo pipefail

          echo "$IOS_CERT_P12_BASE64" | base64 --decode > certificate.p12

          security create-keychain -p "" build.keychain
          security set-keychain-settings -t 3600 -l ~/Library/Keychains/build.keychain
          security unlock-keychain -p "" build.keychain

          security import certificate.p12 -k build.keychain -P "$P12_PASSWORD" -A

          # Allow codesign tools to access the private key in CI
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain

          security list-keychains -s build.keychain
          security default-keychain -s build.keychain

      - name: Install Provisioning Profile
        env:
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          set -euxo pipefail
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles

      - name: Debug signing identities (must show Apple Distribution / iPhone Distribution)
        run: |
          set -euxo pipefail
          echo "== build.keychain identities =="
          security find-identity -v -p codesigning ~/Library/Keychains/build.keychain || true
          echo "== default keychain identities =="
          security find-identity -v -p codesigning || true

      - name: Build iOS IPA
        run: |
          set -euxo pipefail
          flutter build ipa --release

      # App Store Connect API key for altool
      - name: Set up App Store Connect API key for altool
        env:
          APPSTORE_API_KEY: ${{ secrets.APPSTORE_API_KEY }}
          APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
        run: |
          set -euxo pipefail
          mkdir -p ~/.private_keys
          cat > ~/.private_keys/AuthKey_${APPSTORE_API_KEY_ID}.p8 << 'EOF'
          ${APPSTORE_API_KEY}
          EOF
          chmod 600 ~/.private_keys/AuthKey_${APPSTORE_API_KEY_ID}.p8

      - name: Upload to App Store Connect
        env:
          APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          APPSTORE_API_KEY_ISSUER: ${{ secrets.APPSTORE_API_KEY_ISSUER }}
        run: |
          set -euxo pipefail
          xcrun altool \
            --upload-app \
            --type ios \
            --file build/ios/ipa/*.ipa \
            --apiKey "$APPSTORE_API_KEY_ID" \
            --apiIssuer "$APPSTORE_API_KEY_ISSUER"

